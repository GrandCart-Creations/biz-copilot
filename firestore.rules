rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the owner of a company
    function isOwner(companyId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)).data.role == 'owner';
    }
    
    // Check if user has specific role in company
    function hasRole(companyId, allowedRoles) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)).data.role in allowedRoles;
    }
    
    // Check if user has specific permission
    function hasPermission(companyId, module, action) {
      let userDoc = get(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid));
      let permissionString = module + ':' + action;
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) &&
             (permissionString in userDoc.data.permissions || '*' in userDoc.data.permissions);
    }
    
    // Check if user created the resource
    function isResourceOwner() {
      return isAuthenticated() && 
             resource.data.createdBy == request.auth.uid;
    }
    
    // Rate limiting check (prevent spam)
    // For CREATE: resource doesn't exist yet, so always allow
    // For UPDATE: check that enough time has passed since last modification
    function notTooFrequent() {
      // During CREATE, resource doesn't exist - skip rate limiting check
      // During UPDATE, check lastModified timestamp
      return !('lastModified' in resource.data) || 
             request.time > resource.data.lastModified + duration.value(1, 's');
    }
    
    // Validate expense data structure
    // Note: amount may be encrypted (string) or unencrypted (number)
    function isValidExpense() {
      let data = request.resource.data;
      
      // Amount validation: can be number OR encrypted string
      let amountIsValid = ('amount' in data) && 
                         ((data.amount is number && data.amount >= 0 && data.amount < 1000000) ||
                          (data.amount is string && 'amount_encrypted' in data && data.amount.size() > 0));
      
      return data.keys().hasAll(['date', 'category', 'vendor', 'createdBy', 'createdAt']) &&
             amountIsValid &&
             data.createdBy is string &&
             data.createdAt is timestamp;
    }
    
    // Validate income data structure
    function isValidIncome() {
      let data = request.resource.data;
      return data.keys().hasAll(['date', 'category', 'amount', 'createdBy', 'createdAt']) &&
             data.amount is number &&
             data.amount >= 0 &&
             data.amount < 10000000 &&
             data.createdBy is string &&
             data.createdAt is timestamp;
    }
    
    // ============================================
    // USER PROFILES & LEGACY STRUCTURE
    // ============================================
    
    match /users/{userId} {
      // Users can only read/write their own profile
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if isAuthenticated() && request.auth.uid == userId;
      
      // BACKWARDS COMPATIBILITY: Allow users to access their own expenses
      // This supports the existing app structure
      match /expenses/{expenseId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow create: if isAuthenticated() && request.auth.uid == userId;
        allow update: if isAuthenticated() && request.auth.uid == userId;
        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }
      
      // BACKWARDS COMPATIBILITY: Allow users to access their own accounts
      match /accounts/{accountId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow create: if isAuthenticated() && request.auth.uid == userId;
        allow update: if isAuthenticated() && request.auth.uid == userId;
        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }
      
      // Security settings (MFA, etc.)
      match /security/{document=**} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow write: if isAuthenticated() && request.auth.uid == userId;
      }
    }
    
    // ============================================
    // COMPANIES
    // ============================================
    
      match /companies/{companyId} {
      // Read: Allow if user is creator OR is a member (for queries, check createdBy field directly)
      // When querying with where('createdBy', '==', userId), this will work
      allow read: if isAuthenticated() && 
                     (request.auth.uid == resource.data.createdBy ||
                      exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)));
      
      // Create: Any authenticated user can create a company
      allow create: if isAuthenticated() &&
                       request.resource.data.createdBy == request.auth.uid &&
                       request.resource.data.keys().hasAll(['name', 'createdBy', 'createdAt', 'settings']);
      
      // Update: Only company owner OR creator (for initial setup)
      allow update: if isAuthenticated() && 
                     (isOwner(companyId) || 
                      request.auth.uid == resource.data.createdBy);
      
      // Delete: Company owner OR creator (even if user doc can't be read)
      allow delete: if isAuthenticated() && 
                     (isOwner(companyId) || 
                      request.auth.uid == resource.data.createdBy);
      
      // ============================================
      // COMPANY USERS (Role Management)
      // ============================================
      
      match /users/{userId} {
        // Read: Any company member can see other members OR creator can read (for deletion)
        allow read: if isAuthenticated() && 
                       (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                        request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Create: Allow user to create their own document when joining company
        // OR owner can create documents for others
        allow create: if isAuthenticated() && 
                        (request.auth.uid == userId || isOwner(companyId));
        
        // Update: Only owner can manage users and roles (except self can update some fields)
        allow update: if isAuthenticated() && 
                        (isOwner(companyId) || 
                         (request.auth.uid == userId && 
                          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['preferences', 'notifications'])));
        
        // Delete: Owner OR creator can remove users (for company deletion)
        allow delete: if isAuthenticated() && 
                       (isOwner(companyId) || 
                        request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
      }
      
      // ============================================
      // COMPANY EXPENSES (Direct Path)
      // ============================================
      
      match /expenses/{expenseId} {
        // Read: Any company member OR creator (for deletion purposes)
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       (exists(/databases/$(database)/documents/companies/$(companyId)) &&
                        request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy));
        
        // Create: Any company member OR creator can create expenses
        // Check: user is in company users OR user is the company creator
        // Note: notTooFrequent() skipped for CREATE (resource doesn't exist yet)
        allow create: if isAuthenticated() && 
                        request.resource.data.createdBy == request.auth.uid &&
                        isValidExpense() &&
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         (exists(/databases/$(database)/documents/companies/$(companyId)) &&
                          request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy));
        
        // Update: Owner or the user who created it OR creator
        allow update: if isAuthenticated() && 
                        ((exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) &&
                         (isOwner(companyId) || isResourceOwner())) ||
                         (request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy && isResourceOwner())) &&
                        isValidExpense();
        
        // Delete: Owner or the user who created it OR creator (for company deletion)
        allow delete: if isAuthenticated() && 
                        ((exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) &&
                         (isOwner(companyId) || isResourceOwner())) ||
                        request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
      }
      
      // ============================================
      // COMPANY SETTINGS
      // ============================================
      
      match /settings/{settingId} {
        // Read: Any company member OR creator (for deletion purposes)
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Write: Only owner OR creator
        allow write: if isAuthenticated() && 
                      (isOwner(companyId) || 
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
      }
      
      // ============================================
      // EXPENSES MODULE (Legacy Path)
      // ============================================
      
      match /modules/expenses/{expenseId} {
        allow read: if hasPermission(companyId, 'expenses', 'read');
        
        allow create: if hasPermission(companyId, 'expenses', 'write') && 
                         request.resource.data.createdBy == request.auth.uid &&
                         isValidExpense() &&
                         notTooFrequent();
        
        allow update: if hasPermission(companyId, 'expenses', 'write') && 
                         (isOwner(companyId) || isResourceOwner()) &&
                         isValidExpense();
        
        allow delete: if hasPermission(companyId, 'expenses', 'delete') && 
                         (isOwner(companyId) || isResourceOwner());
      }
      
      // ============================================
      // INCOME MODULE
      // ============================================
      
      match /modules/income/{incomeId} {
        allow read: if hasPermission(companyId, 'income', 'read');
        
        allow create: if hasPermission(companyId, 'income', 'write') && 
                         request.resource.data.createdBy == request.auth.uid &&
                         isValidIncome() &&
                         notTooFrequent();
        
        allow update: if hasPermission(companyId, 'income', 'write') && 
                         (isOwner(companyId) || isResourceOwner()) &&
                         isValidIncome();
        
        allow delete: if hasPermission(companyId, 'income', 'delete') && 
                         (isOwner(companyId) || isResourceOwner());
      }
      
      // ============================================
      // INVOICES MODULE
      // ============================================
      
      match /modules/invoices/{invoiceId} {
        allow read: if hasPermission(companyId, 'invoices', 'read');
        allow create: if hasPermission(companyId, 'invoices', 'write') && 
                         request.resource.data.createdBy == request.auth.uid;
        allow update: if hasPermission(companyId, 'invoices', 'write');
        allow delete: if hasPermission(companyId, 'invoices', 'delete') && 
                         (isOwner(companyId) || isResourceOwner());
      }
      
      // ============================================
      // CUSTOMERS MODULE
      // ============================================
      
      match /modules/customers/{customerId} {
        allow read: if hasPermission(companyId, 'customers', 'read');
        allow create: if hasPermission(companyId, 'customers', 'write') && 
                         request.resource.data.createdBy == request.auth.uid;
        allow update: if hasPermission(companyId, 'customers', 'write');
        allow delete: if hasPermission(companyId, 'customers', 'delete') && 
                         isOwner(companyId);
      }
      
      // ============================================
      // PAYROLL MODULE
      // ============================================
      
      match /modules/payroll/{payrollId} {
        allow read: if hasRole(companyId, ['owner', 'admin', 'accountant']);
        allow create: if hasRole(companyId, ['owner', 'admin']) && 
                         request.resource.data.createdBy == request.auth.uid;
        allow update: if hasRole(companyId, ['owner', 'admin']);
        allow delete: if isOwner(companyId);
      }
      
      // ============================================
      // BUSINESS PLANNING MODULE
      // ============================================
      
      match /modules/businessPlans/{planId} {
        allow read: if hasPermission(companyId, 'businessPlanning', 'read');
        allow create: if hasPermission(companyId, 'businessPlanning', 'write') && 
                         request.resource.data.createdBy == request.auth.uid;
        allow update: if hasPermission(companyId, 'businessPlanning', 'write');
        allow delete: if hasPermission(companyId, 'businessPlanning', 'delete') && 
                         isOwner(companyId);
      }
      
      // ============================================
      // AUDIT LOGS (Read-only for users, system writes)
      // ============================================
      
      match /auditLogs/{logId} {
        // Users can only read audit logs, not create/update/delete them
        allow read: if hasRole(companyId, ['owner', 'admin']);
        // System creates logs via Admin SDK, users cannot write
        allow write: if false;
      }
    }
    
    // ============================================
    // GLOBAL AUDIT LOGS (for events without company context)
    // ============================================
    
    match /globalAuditLogs/{logId} {
      // Allow authenticated users to create logs
      allow create: if isAuthenticated();
      // Only admins can read (future feature)
      allow read: if false;
      // Nobody can update/delete
      allow update, delete: if false;
    }
    
    // ============================================
    // DENY ALL OTHER PATHS
    // ============================================
    
    // Explicitly deny access to any paths not defined above
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

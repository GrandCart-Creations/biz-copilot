rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the owner of a company
    function isOwner(companyId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)).data.role == 'owner';
    }
    
    // Check if user has specific role in company
    function hasRole(companyId, allowedRoles) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)).data.role in allowedRoles;
    }
    
    // Check if user has specific permission
    function hasPermission(companyId, module, action) {
      let userDoc = get(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid));
      let permissionString = module + ':' + action;
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) &&
             (permissionString in userDoc.data.permissions || '*' in userDoc.data.permissions);
    }
    
    // Check if user created the resource
    function isResourceOwner() {
      return isAuthenticated() && 
             resource.data.createdBy == request.auth.uid;
    }
    
    // Rate limiting check (prevent spam)
    // For CREATE: resource doesn't exist yet, so always allow
    // For UPDATE: check that enough time has passed since last modification
    function notTooFrequent() {
      // During CREATE, resource doesn't exist - skip rate limiting check
      // During UPDATE, check lastModified timestamp
      return !('lastModified' in resource.data) || 
             request.time > resource.data.lastModified + duration.value(1, 's');
    }
    
    // Validate expense data structure
    // Note: amount may be encrypted (string) or unencrypted (number)
    function isValidExpense() {
      let data = request.resource.data;
      
      // Amount validation: can be number OR encrypted string
      let amountIsValid = ('amount' in data) && 
                         ((data.amount is number && data.amount >= 0 && data.amount < 1000000) ||
                          (data.amount is string && 'amount_encrypted' in data && data.amount.size() > 0));
      
      return data.keys().hasAll(['date', 'category', 'vendor', 'createdBy', 'createdAt']) &&
             amountIsValid &&
             data.createdBy is string &&
             data.createdAt is timestamp;
    }
    
    // Validate income data structure
    function isValidIncome() {
      let data = request.resource.data;
      return data.keys().hasAll(['date', 'category', 'amount', 'createdBy', 'createdAt']) &&
             data.amount is number &&
             data.amount >= 0 &&
             data.amount < 10000000 &&
             data.createdBy is string &&
             data.createdAt is timestamp;
    }
    
    // ============================================
    // USER PROFILES & LEGACY STRUCTURE
    // ============================================
    
    match /users/{userId} {
      // Users can only read/write their own profile
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if isAuthenticated() && request.auth.uid == userId;
      
      // BACKWARDS COMPATIBILITY: Allow users to access their own expenses
      // This supports the existing app structure
      match /expenses/{expenseId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow create: if isAuthenticated() && request.auth.uid == userId;
        allow update: if isAuthenticated() && request.auth.uid == userId;
        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }
      
      // BACKWARDS COMPATIBILITY: Allow users to access their own accounts
      match /accounts/{accountId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow create: if isAuthenticated() && request.auth.uid == userId;
        allow update: if isAuthenticated() && request.auth.uid == userId;
        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }
      
      // Security settings (MFA, etc.)
      match /security/{document=**} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow write: if isAuthenticated() && request.auth.uid == userId;
      }
      
      // Onboarding status
      match /onboarding/{document=**} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow write: if isAuthenticated() && request.auth.uid == userId;
      }
    }
    
    // ============================================
    // COMPANIES
    // ============================================
    
      match /companies/{companyId} {
      // Read: Allow public read for branding (login/signup pages) OR authenticated members
      // Public read allows unauthenticated users to see company name and branding for branded login pages
      // Authenticated reads allow members to see full company data
      allow read: if true; // Public read for branding (name, branding fields only - safe for public)
                  // Note: Sensitive data is in subcollections which remain protected
      
      // Create: Any authenticated user can create a company
      allow create: if isAuthenticated() &&
                       request.resource.data.createdBy == request.auth.uid &&
                       request.resource.data.keys().hasAll(['name', 'createdBy', 'createdAt', 'settings']);
      
      // Update: Only company owner OR creator (for initial setup)
      allow update: if isAuthenticated() && 
                     (isOwner(companyId) || 
                      request.auth.uid == resource.data.createdBy);
      
      // Delete: Company owner OR creator (even if user doc can't be read)
      allow delete: if isAuthenticated() && 
                     (isOwner(companyId) || 
                      request.auth.uid == resource.data.createdBy);
      
      // ============================================
      // COMPANY USERS (Role Management)
      // ============================================
      
      match /users/{userId} {
        // Read: Any company member can see other members OR creator can read (for deletion)
        allow read: if isAuthenticated() && 
                       (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                        request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Create: Allow user to create their own document when joining company
        // OR owner can create documents for others
        allow create: if isAuthenticated() && 
                        (request.auth.uid == userId || isOwner(companyId));
        
        // Update: Only owner can manage users and roles (except self can update some fields)
        // Manager can also update employee roles
        allow update: if isAuthenticated() && 
                        (isOwner(companyId) || 
                         (hasRole(companyId, ['manager']) && 
                          resource.data.role == 'employee' && 
                          request.resource.data.role in ['employee', 'accountant']) ||
                         (request.auth.uid == userId && 
                          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['preferences', 'notifications'])));
        
        // Delete: Owner OR creator can remove users (for company deletion)
        allow delete: if isAuthenticated() && 
                       (isOwner(companyId) || 
                        request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
      }
      
      // ============================================
      // COMPANY INVITATIONS
      // ============================================
      
      match /invitations/{invitationId} {
        // Read: Allow public read for invitations (they're already public via email)
        // This is needed so invitees can see invitation details before logging in
        // Unauthenticated users can read to see company branding and invitation email
        // Security: We verify email match in application code before accepting
        allow read: if true; // Public read - invitation data is already public (sent via email)
        
        // Additional read for company members/creators (more permissive, but allows verification above)
        // The read above already covers this, but keeping for clarity
        
        // Create: Only owners and managers can create invitations
        allow create: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager'])) &&
                        request.resource.data.invitedBy == request.auth.uid &&
                        request.resource.data.email is string &&
                        request.resource.data.role in ['owner', 'manager', 'employee', 'accountant', 'marketingManager', 'developer', 'dataEntryClerk'];
        
        // Update: Owners/managers can update, OR invitee can accept invitation
        // Invitee can only update if: status is pending, and updating to accepted
        // Email verification is done in application code (acceptInvitation function)
        allow update: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager']) ||
                         (resource.data.status == 'pending' &&
                          request.resource.data.status == 'accepted'));
        
        // Delete: Only owners and managers can delete invitations
        allow delete: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager']));
      }
      
      // ============================================
      // COMPANY INCOME
      // ============================================
      
      match /income/{incomeId} {
        // Read: Any company member OR creator
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       (exists(/databases/$(database)/documents/companies/$(companyId)) &&
                        request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy));
        
        // Create: Any company member OR creator can create income
        allow create: if isAuthenticated() && 
                        request.resource.data.createdBy == request.auth.uid &&
                        isValidIncome() &&
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         (exists(/databases/$(database)/documents/companies/$(companyId)) &&
                          request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy));
        
        // Update: Owner or the user who created it OR creator
        allow update: if isAuthenticated() && 
                        ((exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) &&
                         (isOwner(companyId) || isResourceOwner())) ||
                         (request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy && isResourceOwner())) &&
                        isValidIncome();
        
        // Delete: Owner or the user who created it OR creator
        allow delete: if isAuthenticated() && 
                        ((exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) &&
                         (isOwner(companyId) || isResourceOwner())) ||
                         (request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy && isResourceOwner()));
      }
      
      // ============================================
      // FINANCIAL ACCOUNTS
      // ============================================
      
      match /financialAccounts/{accountId} {
        // OWNER ONLY: Financial accounts are sensitive and only owners can access
        allow read, create, update, delete: if isAuthenticated() && isOwner(companyId);
      }
      
      // ============================================
      // FUNDING & INVESTORS
      // ============================================
      
      match /funding/{fundingId} {
        // Read: Company members can read funding (owners and managers)
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Create/Update/Delete: Only owners and managers
        allow create, update, delete: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager'])) &&
                        request.resource.data.createdBy == request.auth.uid;
      }
      
      match /investors/{investorId} {
        // Read: Company members can read investor info (owners, managers, accountants)
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Create/Update/Delete: Only owners and managers
        allow create, update, delete: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager'])) &&
                        request.resource.data.createdBy == request.auth.uid;
      }
      
      // ============================================
      // CONTRACTS
      // ============================================
      
      match /contracts/{contractId} {
        // Read: Company members can read contracts (owners, managers, accountants)
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Create/Update/Delete: Only owners and managers
        allow create, update, delete: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager'])) &&
                        request.resource.data.createdBy == request.auth.uid;
      }
      
      // ============================================
      // VENDORS (Service Provider CRM)
      // ============================================
      
      match /vendors/{vendorId} {
        // Read: Company members can read vendor profiles (for expense matching)
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Create/Update: Any company member can create/update vendor profiles (auto-created from expenses)
        // This allows the system to automatically build vendor CRM from expense data
        allow create, update: if isAuthenticated() && 
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Delete: Only owners and managers
        allow delete: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager']));
      }
      
      // ============================================
      // COMPANY EXPENSES (Direct Path)
      // ============================================
      
      match /expenses/{expenseId} {
        // Read: Any company member OR creator (for deletion purposes)
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       (exists(/databases/$(database)/documents/companies/$(companyId)) &&
                        request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy));
        
        // Create: Any company member OR creator can create expenses
        // Check: user is in company users OR user is the company creator
        // Note: notTooFrequent() skipped for CREATE (resource doesn't exist yet)
        allow create: if isAuthenticated() && 
                        request.resource.data.createdBy == request.auth.uid &&
                        isValidExpense() &&
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         (exists(/databases/$(database)/documents/companies/$(companyId)) &&
                          request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy));
        
        // Update: Owner or the user who created it OR creator
        allow update: if isAuthenticated() && 
                        ((exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) &&
                         (isOwner(companyId) || isResourceOwner())) ||
                         (request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy && isResourceOwner())) &&
                        isValidExpense();
        
        // Delete: Owner or the user who created it OR creator (for company deletion)
        allow delete: if isAuthenticated() && 
                        ((exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) &&
                         (isOwner(companyId) || isResourceOwner())) ||
                        request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
      }
      
      // ============================================
      // COMPANY ACCOUNTS (Bank accounts, credit cards, etc.)
      // ============================================
      
      match /accounts/{accountId} {
        // Read: Any company member OR creator
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Write: Only owner OR creator (managing company accounts)
        allow write: if isAuthenticated() && 
                      (isOwner(companyId) || 
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
      }
      
      // ============================================
      // COMPANY SETTINGS
      // ============================================
      
      match /settings/{settingId} {
        // Read: Any company member OR creator (for deletion purposes)
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Write: Only owner OR creator
        allow write: if isAuthenticated() && 
                      (isOwner(companyId) || 
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
      }
      
      // ============================================
      // COMPANY ONBOARDING
      // ============================================
      
      match /onboarding/{userId} {
        // Read: Company members can read their own onboarding status
        // Owners/managers can read all onboarding statuses
        allow read: if isAuthenticated() && 
                      (request.auth.uid == userId ||
                       isOwner(companyId) ||
                       hasRole(companyId, ['manager']) ||
                       exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)));
        
        // Create/Update: User can create/update their own onboarding completion
        // Owners can update all onboarding statuses
        allow create, update: if isAuthenticated() && 
                                (request.auth.uid == userId ||
                                 isOwner(companyId));
        
        // Delete: Only owners
        allow delete: if isAuthenticated() && isOwner(companyId);
      }
      
      // ============================================
      // EXPENSES MODULE (Legacy Path)
      // ============================================
      
      match /modules/expenses/{expenseId} {
        allow read: if hasPermission(companyId, 'expenses', 'read');
        
        allow create: if hasPermission(companyId, 'expenses', 'write') && 
                         request.resource.data.createdBy == request.auth.uid &&
                         isValidExpense() &&
                         notTooFrequent();
        
        allow update: if hasPermission(companyId, 'expenses', 'write') && 
                         (isOwner(companyId) || isResourceOwner()) &&
                         isValidExpense();
        
        allow delete: if hasPermission(companyId, 'expenses', 'delete') && 
                         (isOwner(companyId) || isResourceOwner());
      }
      
      // ============================================
      // INCOME MODULE
      // ============================================
      
      match /modules/income/{incomeId} {
        allow read: if hasPermission(companyId, 'income', 'read');
        
        allow create: if hasPermission(companyId, 'income', 'write') && 
                         request.resource.data.createdBy == request.auth.uid &&
                         isValidIncome() &&
                         notTooFrequent();
        
        allow update: if hasPermission(companyId, 'income', 'write') && 
                         (isOwner(companyId) || isResourceOwner()) &&
                         isValidIncome();
        
        allow delete: if hasPermission(companyId, 'income', 'delete') && 
                         (isOwner(companyId) || isResourceOwner());
      }
      
      // ============================================
      // INVOICES MODULE
      // ============================================
      
      match /modules/invoices/{invoiceId} {
        allow read: if hasPermission(companyId, 'invoices', 'read');
        allow create: if hasPermission(companyId, 'invoices', 'write') && 
                         request.resource.data.createdBy == request.auth.uid;
        allow update: if hasPermission(companyId, 'invoices', 'write');
        allow delete: if hasPermission(companyId, 'invoices', 'delete') && 
                         (isOwner(companyId) || isResourceOwner());
      }
      
      // ============================================
      // CUSTOMERS MODULE
      // ============================================
      
      match /modules/customers/{customerId} {
        allow read: if hasPermission(companyId, 'customers', 'read');
        allow create: if hasPermission(companyId, 'customers', 'write') && 
                         request.resource.data.createdBy == request.auth.uid;
        allow update: if hasPermission(companyId, 'customers', 'write');
        allow delete: if hasPermission(companyId, 'customers', 'delete') && 
                         isOwner(companyId);
      }
      
      // ============================================
      // PAYROLL MODULE
      // ============================================
      
      match /modules/payroll/{payrollId} {
        allow read: if hasRole(companyId, ['owner', 'admin', 'accountant']);
        allow create: if hasRole(companyId, ['owner', 'admin']) && 
                         request.resource.data.createdBy == request.auth.uid;
        allow update: if hasRole(companyId, ['owner', 'admin']);
        allow delete: if isOwner(companyId);
      }
      
      // ============================================
      // BUSINESS PLANNING MODULE
      // ============================================
      
      match /modules/businessPlans/{planId} {
        allow read: if hasPermission(companyId, 'businessPlanning', 'read');
        allow create: if hasPermission(companyId, 'businessPlanning', 'write') && 
                         request.resource.data.createdBy == request.auth.uid;
        allow update: if hasPermission(companyId, 'businessPlanning', 'write');
        allow delete: if hasPermission(companyId, 'businessPlanning', 'delete') && 
                         isOwner(companyId);
      }
      
      // ============================================
      // ACCOUNTS RECEIVABLE (AR) - CUSTOMERS
      // ============================================
      
      match /customers/{customerId} {
        // Read: Company members can read customers
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Create: Company members can create customers
        allow create: if isAuthenticated() && 
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy) &&
                        request.resource.data.createdBy == request.auth.uid &&
                        request.resource.data.keys().hasAll(['createdBy']) &&
                        ('name' in request.resource.data || 'company' in request.resource.data) &&
                        'email' in request.resource.data;
        
        // Update: Company members can update customers
        allow update: if isAuthenticated() && 
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Delete: Only owners and managers
        allow delete: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager']));
      }
      
      // ============================================
      // ACCOUNTS RECEIVABLE (AR) - INVOICES
      // ============================================
      
      match /invoices/{invoiceId} {
        // Read: Company members can read invoices
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Create/Update: Company members can create/update invoices
        allow create, update: if isAuthenticated() && 
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy) &&
                        request.resource.data.createdBy == request.auth.uid;
        
        // Delete: Only owners and managers
        allow delete: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager']));
      }
      
      // ============================================
      // ACCOUNTS RECEIVABLE (AR) - QUOTES
      // ============================================
      
      match /quotes/{quoteId} {
        // Read: Company members can read quotes
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Create/Update: Company members can create/update quotes
        allow create, update: if isAuthenticated() && 
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy) &&
                        request.resource.data.createdBy == request.auth.uid;
        
        // Delete: Only owners and managers
        allow delete: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager']));
      }
      
      // ============================================
      // ACCOUNTS RECEIVABLE (AR) - SUBSCRIPTIONS (SaaS)
      // ============================================
      
      match /subscriptions/{subscriptionId} {
        // Read: Company members can read subscriptions
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Create/Update: Company members can create/update subscriptions
        allow create, update: if isAuthenticated() && 
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy) &&
                        request.resource.data.createdBy == request.auth.uid;
        
        // Delete: Only owners and managers
        allow delete: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager']));
      }
      
      // ============================================
      // MARKETING MODULE
      // ============================================
      
      match /campaigns/{campaignId} {
        // Read: Company members can read campaigns
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Create/Update: Company members can create/update campaigns
        allow create, update: if isAuthenticated() && 
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy) &&
                        request.resource.data.createdBy == request.auth.uid;
        
        // Delete: Only owners, managers, and marketing managers
        allow delete: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager', 'marketingManager']));
      }
      
      match /socialAccounts/{accountId} {
        // Read: Company members can read social accounts
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Create/Update: Company members can create/update social accounts
        allow create, update: if isAuthenticated() && 
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy) &&
                        request.resource.data.createdBy == request.auth.uid;
        
        // Delete: Only owners, managers, and marketing managers
        allow delete: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager', 'marketingManager']));
      }
      
      match /marketingTasks/{taskId} {
        // Read: Company members can read marketing tasks
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Create/Update: Company members can create/update tasks
        allow create, update: if isAuthenticated() && 
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy) &&
                        request.resource.data.createdBy == request.auth.uid;
        
        // Delete: Only owners, managers, and marketing managers
        allow delete: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager', 'marketingManager']));
      }
      
      match /marketingAssets/{assetId} {
        // Read: Company members can read marketing assets
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Create: Company members can create assets
        allow create: if isAuthenticated() && 
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy) &&
                        request.resource.data.createdBy == request.auth.uid;
        
        // Delete: Only owners, managers, and marketing managers
        allow delete: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager', 'marketingManager']));
      }
      
      match /leads/{leadId} {
        // Read: Company members can read leads
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Create/Update: Company members can create/update leads
        allow create, update: if isAuthenticated() && 
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy) &&
                        request.resource.data.createdBy == request.auth.uid;
        
        // Delete: Only owners, managers, and marketing managers
        allow delete: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager', 'marketingManager']));
      }
      
      // ============================================
      // PROJECTS MODULE
      // ============================================
      
      match /projects/{projectId} {
        // Read: Company members can read projects
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Create/Update: Company members can create/update projects
        allow create, update: if isAuthenticated() && 
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy) &&
                        request.resource.data.createdBy == request.auth.uid;
        
        // Delete: Only owners, managers, and marketing managers
        allow delete: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager', 'marketingManager']));
      }
      
      // Project Configuration
      match /settings/projectConfig {
        // Read: Company members can read project config
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Write: Only owners and managers
        allow write: if isAuthenticated() && 
                       (isOwner(companyId) || hasRole(companyId, ['manager']));
      }
      
      // ============================================
      // FORECASTING & BUDGETING MODULE
      // ============================================
      
      match /budgets/{budgetId} {
        // Read: Company members can read budgets
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Create/Update: Company members can create/update budgets
        allow create, update: if isAuthenticated() && 
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy) &&
                        request.resource.data.createdBy == request.auth.uid;
        
        // Delete: Only owners, managers
        allow delete: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager']));
      }
      
      match /forecasts/{forecastId} {
        // Read: Company members can read forecasts
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Create/Update: Company members can create/update forecasts
        allow create, update: if isAuthenticated() && 
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy) &&
                        request.resource.data.createdBy == request.auth.uid;
        
        // Delete: Only owners, managers
        allow delete: if isAuthenticated() && 
                        (isOwner(companyId) || hasRole(companyId, ['manager']));
      }
      
      // ============================================
      // NOTIFICATIONS MODULE
      // ============================================
      
      match /notifications/{notificationId} {
        // Read: Company members can read their own notifications or company-wide notifications
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                       request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy) &&
                      (resource.data.userId == null || resource.data.userId == request.auth.uid || request.auth.uid == resource.data.userId);
        
        // Create: System or company members can create notifications
        allow create: if isAuthenticated() && 
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy);
        
        // Update: Users can only update their own notifications (mark as read)
        allow update: if isAuthenticated() && 
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy) &&
                        (resource.data.userId == null || resource.data.userId == request.auth.uid);
        
        // Delete: Users can delete their own notifications
        allow delete: if isAuthenticated() && 
                        (exists(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid)) ||
                         request.auth.uid == get(/databases/$(database)/documents/companies/$(companyId)).data.createdBy) &&
                        (resource.data.userId == null || resource.data.userId == request.auth.uid);
      }
      
      // ============================================
      // AUDIT LOGS (Read-only for users, system writes)
      // ============================================
      
      match /auditLogs/{logId} {
        // Users can only read audit logs, not create/update/delete them
        allow read: if hasRole(companyId, ['owner', 'admin']);
        // System creates logs via Admin SDK, users cannot write
        allow write: if false;
      }
    }
    
    // ============================================
    // GLOBAL AUDIT LOGS (for events without company context)
    // ============================================
    
    match /globalAuditLogs/{logId} {
      // Allow authenticated users to create logs
      allow create: if isAuthenticated();
      // Only admins can read (future feature)
      allow read: if false;
      // Nobody can update/delete
      allow update, delete: if false;
    }
    
    // ============================================
    // DENY ALL OTHER PATHS
    // ============================================
    
    // Explicitly deny access to any paths not defined above
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
